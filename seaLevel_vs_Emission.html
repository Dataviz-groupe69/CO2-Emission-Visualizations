<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Datavis project</title>
  <style>
  .hidden {
    display: none;
  }
  div.tooltip {
    position: absolute;			
    text-align: center;			
    				
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
  }
  </style>
</head>
<body>
<div>
  <div id="title">
    <p>CO2 et le niveau de la mer</p>
    <p>
      Le graph ci-dessous présente la relation entre l'émission CO2 et le niveau de la mer
      avec les données réels entre 1950 et 2014
    </p>
  </div>
  <div id="charts"></div>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
  let margin = {
    top: 60,
    right: 20,
    bottom: 30,
    left: 30
  }
  let width = window.innerWidth- margin.left - margin.right
  let height = window.innerHeight*0.75- margin.top - margin.bottom
  let svg = d3.select("div#charts").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  let tooltip = d3.select("div#charts").append("div")
                  .attr("class", "hidden tooltip")

  d3.csv("./seaLevel_co2.csv",function (error,data) {
    // console.log(data)
    visualization(data)
  })

  function visualization(data) {
    let colorScale = d3.scaleOrdinal(d3.schemeCategory20)
    let xScale = d3.scaleLinear().domain(d3.extent(data, function(d) {
      return parseInt(d['emission'])
    })).range([0, height])
    let yScale = d3.scaleLinear().domain(d3.extent(data, function(d) {
      return parseInt(d['CSIRO'])
    })).range([height, 0])

    let xAxis = d3.axisBottom(xScale).ticks(5)
    let yAxis = d3.axisLeft(yScale).ticks(5)

    svg.append('g')
      .attr('transform', 'translate(0,' + height + ')')
      .attr('class', 'x-axis')
      .call(xAxis)
    svg.append('g')
      .attr('transform', 'translate(0, 0)')
      .attr('class', 'y-axis')
      .call(yAxis)
    svg.append('text')
      .attr('x', 5)
      .attr('y', 0)
      .attr('class', 'label')
      .text('CSIRO')
    svg.append('text')
      .attr('x', height)
      .attr('y', height - 5)
      .attr('class', 'label')
      .text('CO2')

    svg.selectAll('circle')
      .data(data)
      .enter()
      .append('circle')
      .transition()
      .delay(function(_, i) { return i*100 })
      .duration(500)
      .attr('r', 8)
      .attr('cx', function(d) { return xScale(d['emission'])})
      .attr('cy', function(d) { return yScale(d['CSIRO'])})
      .style('fill', 'rgb(115, 171, 243)')
      
    svg.selectAll('circle').on('mouseover', mouseover)
      .on('mouseout', mouseout)
  }

  function mouseover(d) {
    // console.log('Year: ', d['Year'])
    d3.selectAll('circle')
      .filter(function(e) {
        return e !== d
      })
      .style('opacity', 0.09)
    
    let mouse = d3.mouse(svg.node()).map(function(x) {
      return parseInt(x)
    })
    tooltip.classed("hidden", false)
           .attr("style", "left:" + (mouse[0] + 45) +
            "px; top:" + (mouse[1] + 45) + "px")
    if(d) {
      tooltip.html('YEAR: ' + d['Year'] + '<br/>' + 'CSIRO: ' + parseFloat(d['CSIRO']).toFixed(2) + '<br/>' + 'CO2: ' + d['emission'])
    } else {
      tooltip.html('undefined')
    }
  }

  function mouseout(d) {
    d3.selectAll('circle')
      .filter(function(e) {
        return e !== d
      })
    .style('opacity', 1)
    tooltip.classed("hidden", true)
  }
</script>

</body>
</html>