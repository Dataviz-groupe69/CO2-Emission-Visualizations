<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider/build/d3-simple-slider.js"></script>
    <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
    <script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <title>
        DataVis Project
    </title>
    <style>
        @import "./style.css";
    </style>
</head>
<body>
<nav>
    <h2 style="text-align: center"> Proportion de co2 par pays avec prédiction des températures  et de de l'émission de co2 future </h2>
    <div>
        <input id="slider" type="range" value="69" min="1" max="101" step="1" width="200" />
        <span id="year">2019</span>
    </div>
    <div>
        <label>
            <input  type="radio" name="brand" value="Option1" checked="true"/>
        </label>
        <label>
            <input  type="radio" name="brand" value="Option2" />
        </label>
        <input id="number_graph" type="range" value="1" min="1" max="10" step="1" width="8%" />
        <span id="graph" >1 graph comparaison</span>
    </div>
    <div class="legend1">
        <div class="legend1"> <p class="country-name"><span class="key-dot big"></span>Big Emission</p> </div>
        <div class="legend1"> <p class="country-name"><span class="key-dot meduim"></span>Medium Emission</p> </div>
        <div class="legend1"> <p class="country-name"><span class="key-dot small"></span>Small Emission</p> </div>
    </div>
    <div class="accueil">
        <button onclick="window.location='./index.html'">Accueil </button>
    </div>
</nav>
<script>
    var Prograss = true;
    var brands = ['Progress Graph', 'Comparaison Graph'];
    var limit = 1;
    var data_comparaison = new Array();
    var names = new Array();
    var indices = new Array();
    d3.select("#number_graph").on("input",function () {
        d3.select("#graph").text(this.value + " graphs comparaison");
        limit = Number(this.value);
        data_comparaison = [];
        names = [];
        indices = [];
        remove_graph();

    })
    var radios =
        d3.select('.panel.left').selectAll('input[name="brand"]').data(brands);
    d3.selectAll("label")
        .data(brands)
        .append("text")
        .text(function(d) { return d; })
        .style("font-family", "Arial")
        .style("font-size", "16px")
        .style("font-weight", "bold");

    const diameter = Math.ceil(window.innerWidth*0.5);
    format = d3.format(",d");
    var longueur_graph = Math.ceil(window.innerWidth*0.4);
    const svg = d3.select("body").append("svg")
        .attr("width", 1.8*diameter)
        .attr("height", diameter*1.5)
        .attr("id", "svg");

    const g = svg.append("g").attr("transform", "translate(2,2)");
    const pack = d3.pack()
        .size([diameter - 4, diameter - 4])
        .padding(2);

    d3.select("body").selectAll('input[name="brand"]').on("change", function() {
        Prograss = ! Prograss;
        if(!Prograss){
            document.getElementById("graph").style.visibility = "visible";
            document.getElementById("number_graph").style.visibility = "visible";
        }else{
            document.getElementById("graph").style.visibility = "hidden";
            document.getElementById("number_graph").style.visibility = "hidden";
        }
        console.log(Prograss);
        remove_graph();
        //svg.selectAll("#legend").remove();
    });
    d3.json("./final_1.json",function(error, root) {
        var year = 2019;
        var choice = 69;
        d3.select("#slider").on("input", function() {
            var root_2 = root;
            year = Number(1949) + Number(this.value)
            choice = this.value - 1;
            d3.select('#year').text(year);
            //console.log(root_2);
            g.selectAll(".node").remove();
            draw_nodes(root_2,choice,year);
        });
        draw_nodes(root,69,2019);


    })

    function draw_nodes(data,choice,year){
        // ici on remove en cas de changement d'années après compraison de graphes
        remove_graph();
        //svg.selectAll("#legend").remove();
        var root_1 = d3.hierarchy(data)
        // ici on calcule l'emission par continent
            .sum(function(d) { if(d.data && d.data.annees[choice] == year) {return d.data.emissions[choice]} else return 0; })
            .sort(function(a, b) { return (  b.value - a.value); });
        // ici on recupère la liste des noeuds (soit pays ou continent
        var node = g.selectAll(".node")
            .data(pack(root_1).descendants())
            .enter().append("g")
            .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        node.append("circle")
            .attr("r", function(d) { return d.r>5 ? d.r:5; })
            .attr("fill",function (d) {
                if(d.children){
                    return "#1F77B4";
                }else{
                    // ici si l'emission de co2 d'un pays est superieure a 0.3 de l'emission par son continent
                    // on le colore en rouge (danger) sinon en bleu
                    if((d.value/d.parent.value)>=0.3){
                        return "#b43122";
                    }else if(d.value/d.parent.value>=0.15){
                        return  "#ff4009";
                    }else{
                    return  "#1F77B4";
                }
            }});
        node
            .on("click",function (d) {
                if(!Prograss) {
                    console.log(data_comparaison.length);
                    if (data_comparaison.length >= limit) {
                        data_comparaison = [];
                        names = [];
                        indices = [];
                        remove_graph();
                    }
                    if (d.children) {
                        //ici le cas de survoler le noeud monde
                        if (d.data.name === "monde") {
                            //draw_graph(d.children, d.data.name, 1,"monde")
                            data_comparaison.push(d.children);
                            names.push(d.data.name);
                            indices.push(1)
                        } else {
                            // ici le cas de selectionner d'un continent
                            data_comparaison.push(d.children);
                            names.push(d.data.name);
                            indices.push(2)
                        }
                        // ici le cas de selection  d'un pays
                    } else {

                        data_comparaison.push(d.data.data);
                        names.push(d.data.pays);
                        indices.push(3)
                    }
                    if (data_comparaison.length == limit) {
                        graphs_comparaison(data_comparaison, names, indices);
                    }
                }
            }).on("mouseout",function () {
            if(Prograss){
                remove_graph();
                svg.selectAll("#tooltip").remove();
            }

            //svg.selectAll("g").remove()
        }).on("mouseover",function(d){
            if(Prograss){
                if (d.children) {
                    //ici le cas de survoler le noeud monde
                    if (d.data.name === "monde") {
                        draw_graph(d.children, d.data.name, 1,"monde")

                    } else {
                        // ici le cas de survoler un continent
                        draw_graph(d.children, d.data.name, 2,d.data.name)
                    }
                    // ici le cas de survoler un pays
                } else {
                    // console.log(d)
                    draw_graph(d.data.data, d.data.pays, 3,d.parent.data.name);
                    //draw_bar_chart(d.data.data.proportions);
                }
            }
        });
        // ici pour chaque noeud on rajoute un titre qui s'affiche quand on survole un noeud(pays ou continent)
        node.append("title")
            .text(function(d) {var res; if(d.data.name ){res = d.data.name}else{res = d.data.pays} return res+ "\n" + "co2 emission for " +year+" is " + format(d.value) +" µg/m³"; });
        node.filter(function(d) { return !d.children; })
            .append("text")
            .attr("dy", "0.3em")
            .style("font-weight", "bold")
            .attr("fill","#FFFFFF")
            .text(function(d) { return d.r>5 ? ( d.data.pays.substring(0, d.r / 3)):( d.data.pays.substring(0, 5 / 3)); })
    }

    // une fonction qui sert a dessiner le line chart
    function draw_bar_chart(data) {
        height = 1.6*longueur_graph;
        const x = d3.scaleBand()
            .range([diameter+20,diameter*1.7 ])
            .padding(0.6);

        const y = d3.scaleLinear()
            .range([longueur_graph*1.6, longueur_graph*1.21]);
        /*const svg1= d3.select("#chart").append("svg")
            .attr("id", "svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);*/

            // Mise en relation du scale avec les données de notre fichier
            // Pour l'axe X, c'est la liste des pays
            // Pour l'axe Y, c'est le max des populations
            x.domain(['Solid Fuel','Liquid Fuel','Gas Fuel','Cement','Gas Flaring','Per Capita']);
            y.domain([0, 100]);
            var dd = ['Solid Fuel','Liquid Fuel','Gas Fuel','Cement','Gas Flaring','Per Capita'];
            // Ajout de l'axe X au SVG
            // Déplacement de l'axe horizontal et du futur texte (via la fonction translate) au bas du SVG
            // Selection des noeuds text, positionnement puis rotation
            svg.append("g")
                //.attr("transform", "translate(0," + height + ")")
                .attr('id','tooltip')
                .call(d3.axisBottom(x).tickSize(5))
                .attr("transform", "translate(0," + longueur_graph*1.6 + ")")
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-65)");

            // Ajout de l'axe Y au SVG avec 6 éléments de légende en utilisant la fonction ticks (sinon D3JS en place autant qu'il peut).
            svg.append("g").attr("id",'tooltip')
                .call(d3.axisLeft(y).ticks(6)).attr("transform", "translate(0" + (diameter+20)+ ")");
            console.log(data);
            // Ajout des bars en utilisant les données de notre fichier data.tsv
            // La largeur de la barre est déterminée par la fonction x
            // La hauteur par la fonction y en tenant compte  de la population
            // La gestion des events de la souris pour le popup
            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d,i) { return x(dd[i]); })
                .attr("width",30)
                .attr("y", function(d) { return y(d*100);})
                .attr("height", function(d) { return  height - y(d*100); })
                .attr("fill",'#3498DB')
                /*.on("mouseover", function(d,i) {
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    div.html("Population : " + d[i])
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 50) + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                });*/
        svg.append("text")
            .attr("x", diameter*1.4)
            .attr("y", longueur_graph *1.3)
            .attr("class","surface")
            .attr("text-anchor", "middle")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .text("Pourcentage d'emission par chaque secteur %");

    }
    function draw_graph(data,title,indice,continent){

        var compute_data = compute_data_object(data,indice);
        var total_emission = compute_data.total_emission;
        var data_object = compute_data.data;
        draw_bar_chart(compute_data.proportion);
       // console.log(data_object)
        var y = d3.scaleLinear().range([longueur_graph*1.15, longueur_graph*0.3]);

        var parseTime = d3.timeParse("%d-%b-%y");
        var x = d3.scaleTime()
            .domain([new Date(1950,0,0),new Date(2050,1,1)])
            .range([diameter+20, diameter*1.7]);

        var xAxis = d3.axisBottom(x)
            .tickFormat(d3.timeFormat("%Y"));

        // define the line
        var valueline = d3.line()
            .x(function(d) { return x(new Date(d.annee,0,0)); })
            .y(function(d) { return y(d.emission); });
        // define the area
        //console.log(data)
        var area = d3.area()
            .x(function(d) { return x(new Date(d.annee,0,0)); })
            .y0(longueur_graph*1.15)
            .y1(function(d) { return y(d.emission); });

        y.domain([0, d3.max(data_object, function(d) { return d.emission; })]);
        var z = ["#98abc5", "#a5de8f", "#7b6888", "#00FFFF", "#FFAF2B", "#d0743c", "#ff8c00","#b43122","#ffa268"];
        //var color = d3.scale.category10();
        var continents = {"AFRIQUE":0,"EUROPE":1,"NORTH AMERICA":2,"ASIA":3,"AUSTRALIA":4,"SOUTH AMERICA":5,"OTHER":6,"CENTRAL AMERICA":7,"monde":8};

        var continent_number = continents[continent];
        //console.log(continent_number);
        svg.append("path")
            .data([data_object])
            .attr("class", "area")
            .attr("d", area)
            .attr("fill", z[continent_number]);

        //console.log(z(continents[continent]));
        // ajouter le path de line
        svg.append("path")
            .data([data_object])
            .attr("class", "line")   //
            .attr("stroke","#b43122")
            .style("stroke-width","3px")
            .attr("d", valueline);

        line_chart(xAxis,y,title+" Co2 emission line chart (µg/m³)");

        svg.append("text")
            .attr("x", diameter*1.4)
            .attr("y", longueur_graph *1.1)
            .attr("class","surface")
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("Total emissions = "+ total_emission +" µg/m³");

    }

    function graphs_comparaison(data_comp,names,indices){
        var y = d3.scaleLinear().range([longueur_graph*1.2, longueur_graph*0.3]);

        var parseTime = d3.timeParse("%d-%b-%y");
        var x = d3.scaleTime()
            .domain([new Date(1950,0,0),new Date(2050,1,1)])
            .range([diameter+20, diameter*1.7]);

        var xAxis = d3.axisBottom(x)
            .tickFormat(d3.timeFormat("%Y"));

        // definie la line
        var valueline = d3.svg.line()
            .x(function(d) { return x(new Date(d.annee,0,0)); })
            .y(function(d) { return y(d.emission); });
        var max = 0;
        var data_object;
        var color = d3.scale.category10();
        color.domain(names);
        var data_ready =new  Array();
        for(var i =0;i<data_comp.length;i++) {
            data_object = compute_data_object(data_comp[i], indices[i]).data;
            data_ready.push({"name":names[i],"values":data_object});
            max = Math.max(max, d3.max(data_object, function (d) {
                return d.emission;
            }));
        }
        y.domain([0, max]);
        /*for (var j=0;j<data_ready.length;j++){
            svg.append("path")
                .data([data_ready[j]])
                .attr("class", "line")
                .attr("stroke",color(j))
                .attr("d", valueline);

            svg.append("text")
                .attr("x", diameter*1.2)
                .attr("y", longueur_graph*0.3 +j*15)
                .attr("id","legend")
                .attr("class", "legend")
                .attr("fill",color(j))
                .text(names[j]);
        }
        */

        // ici on dessine les axes de line chart
        line_chart(xAxis,y," Comparaison of Co2 emission (µg/m³)");

        // ici c'est l'etape de dessiner les graphes de comparaison avec un petit circle et une bar
        // qui afficher le detail de l'emission

        var city = svg.selectAll(".city")
            .data(data_ready)
            .enter().append("g")
            .attr("class", "city");

        city.append("path")
            .attr("class", "line")
            .attr("d", function(d) {
                return valueline(d.values);
            })
            .style("stroke", function(d) {
                return color(d.name);
            }).style("stroke-width","1px");

        city.append("text")
            .datum(function(d) {
                return {
                    name: d.name,
                    value: d.values[0]
                };
            })
            .attr("x", diameter*1.2)
            .attr("y", function (d,i) {
                return longueur_graph*0.3 +i*12;
            })
            .attr("fill",function (d) {
                console.log(color(d.name));
                return color(d.name)
            })
            .attr("id","legend")
            .text(function(d) {
                return d.name;
            });



        var mouseG = svg.append("g")
            .attr("class", "mouse-over-effects")
            .attr("id","mouse-effects");

        mouseG.append("path") // this is the black vertical line to follow mouse
            .attr("class", "mouse-line")
            .style("stroke", "black")
            .style("stroke-width", "1px")
            .style("opacity", "0");

        var lines = document.getElementsByClassName('line');
        //console.log(lines)
        var mousePerLine = mouseG.selectAll('.mouse-per-line')
            .data(data_ready)
            .enter()
            .append("g")
            .attr("class", "mouse-per-line");

        mousePerLine.append("circle")
            .attr("r", 10)
            .attr('class',"circle-mouse")
            .style("stroke", function (d) {
                return color(d.name);
            })
            .style("fill", "none")
            .style("stroke-width", "1px")
            .style("opacity", "0");

        mousePerLine.append("text")
            .attr("transform", "translate(25,3)");

        mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
            .attr('width', 0.7*diameter-20) // can't catch mouse events on a g element
            .attr('height', 0.9*longueur_graph)
            .attr("x",diameter+20)
            .attr("y",longueur_graph*0.3)
            .attr('fill', 'none')
            .attr('pointer-events', 'all')
            .on('mouseout', function() { // on mouse out hide line, circles and text
                d3.select(".mouse-line")
                    .style("opacity", "0");
                d3.selectAll(".mouse-per-line circle")
                    .style("opacity", "0");
                d3.selectAll(".mouse-per-line text")
                    .style("opacity", "0");
            })
            .on('mouseover', function() { // on mouse in show line, circles and text
                d3.select(".mouse-line")
                    .style("opacity", "1");
                d3.selectAll(".mouse-per-line circle")
                    .style("opacity", "1");
                d3.selectAll(".mouse-per-line text")
                    .style("opacity", "1");
            })
            .on('mousemove', function() { // mouse moving over canvas
                var mouse = d3.mouse(this);
                d3.select(".mouse-line")
                    .attr("d", function() {
                        var d = "M" + mouse[0] + "," + (1.2*longueur_graph);
                        d += " " + mouse[0] + "," + (0.3*longueur_graph);
                        //console.log(d,mouse[0]);
                        return d;
                    });
                d3.selectAll(".mouse-per-line")
                    .attr("transform", function(d, i) {
                        //console.log(lines[i].getTotalLength());
                        var beginning = 0;
                        if(lines[i]) {
                            var end = lines[i].getTotalLength();

                            var target;
                            //console.log(lines[i].getTotalLength());
                            //console.log(lines.length)
                            while (true) {
                                //console.log(beginning,end);
                                target = Math.floor((beginning + end) / 2);
                                //console.log("target is : " +target);

                                pos = lines[i].getPointAtLength(target);

                                //console.log(pos);
                                if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                                    break;
                                }
                                if (pos.x < mouse[0]) beginning = target;
                                else if (pos.x > mouse[0]) end = target;
                                else break;
                            }

                            d3.select(this).select('text')
                                .text(y.invert(pos.y).toFixed(2));
                            return "translate(" + mouse[0] + "," + pos.y + ")";
                        }
                    });
            });
    }
    function compute_data_object(data,indice) {
        //console.log(data);
        var data_object = new Array();
        var total_emission = 0;
        var proportion = [0,0,0,0,0,0];
        //console.log(proportion);
        var tot;
        switch (indice) {
            case 1:
                var sum;
                tot =0;
                for(var a=0;a<data.length;a++){
                    tot += data[a].children.length;
                    for(var b =0;b<data[a].children.length;b++){
                        for(var k=0;k<6;k++){
                            if(data[a].children[b].data.data.proportions) {
                                proportion[k] += (data[a].children[b].data.data.proportions[k]);
                            }
                        }
                    }
                }
                for (var compt = 0; compt < 100; compt++) {
                    sum = 0;
                    for (var i = 0; i < data.length; i++) {
                        //data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})
                        for (var j = 0; j < data[i].children.length; j++) {

                            if (data[i].children[j].data.data.emissions[compt]) {
                                sum += data[i].children[j].data.data.emissions[compt]
                            }
                        }

                    }

                    total_emission += sum;
                    data_object.push({"annee": 1950 + compt, "emission": sum})
                }

                for(var t=0;t<proportion.length;t++){
                    proportion[t] /=tot;
                }

                break;
            case 2:
                var sum;
                for(var a=0;a<data.length;a++){
                    for(var k=0;k<6;k++){
                        if(data[a].data.data.proportions) {
                            proportion[k] += Number(data[a].data.data.proportions[k]);
                        }
                    }
                }
                for (var compt = 0; compt < 100; compt++) {
                    sum = 0;
                    for (var i = 0; i < data.length; i++) {
                        //data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})

                        if (data[i].data.data.emissions[compt]) {
                            sum += data[i].data.data.emissions[compt]
                        }

                    }

                    total_emission += sum;
                    data_object.push({"annee": 1950 + compt, "emission": sum})
                }
                for(var t=0;t<proportion.length;t++){
                    proportion[t] /=data.length;
                }

                break;
            case 3:
                for (var i = 0; i < data.annees.length; i++) {
                    data_object.push({"annee": data.annees[i], "emission": data.emissions[i]})
                }
                proportion = data.proportions;
                total_emission = d3.sum(data.emissions);
                break;
        }
        return {"data": data_object, "total_emission": total_emission,"proportion":proportion};
    }
    // une fonction de suppression des axes et de legend du svg
    function remove_graph() {
        svg.selectAll("path").remove();
        svg.select("#Xaxis").remove();
        svg.select("#Yaxis").remove();
        svg.select("#title").remove();
        svg.select("#surface").remove();
        svg.selectAll("#legend").remove();
        //svg.selectAll("circle-mouse").remove();
        d3.selectAll(".city").remove();
        d3.selectAll("line").remove();
        //svg.selectAll("rect").remove();
        svg.selectAll("rect.bar").remove();
        svg.selectAll("text.surface").remove();

        svg.selectAll("g#mouse-effects.mouse-over-effects").remove();
    }
    function line_chart(xAxis,y,message){
        // add x Axis
        svg.append("g")
            .attr("id","Xaxis")   //
            .attr("transform", "translate(0," + longueur_graph*1.15 + ")")
            .call(xAxis);

        // add the Y Axis
        svg.append("g")
            .attr("id","Yaxis")
            .attr("transform", "translate(0" + (diameter+20)+ ")")
            .attr("y", 6)
            .attr("dy", ".71em")
            .call(d3.axisLeft(y));

        // ici on ajoute le titre de line chart
        svg.append("text")
            .attr("x", diameter*1.4)
            .attr("y", longueur_graph*0.2)
            .attr("id","title")
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-weight", "bold")
            .text(message); //title+ " Co2 emissions line chart"
    }

</script>
</body>
</html>