<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script src="https://unpkg.com/d3-simple-slider/build/d3-simple-slider.js"></script>
    <title>
        DataVis Project
    </title>
    <style>
        body {
            background-color: rgb(255, 255, 255);
        }
        #slider{
            background-color: rgb(0, 255, 255);
            color:#00FFFF;
            width: 40%;
            margin-left: 30%;
        }
        circle {

            fill-opacity: .25;
            stroke: rgb(31, 119, 180);
            stroke-width: 1px;
        }

        .leaf circle {
            fill-opacity: 1;
        }

        text {
            font: 10px sans-serif;
            text-anchor: middle;
            cursor: pointer; cursor: hand
        }
        .line {
            fill: none;
            stroke: #b43122;
            stroke-width: 4px;
        }
        /*
        .area {
            fill: #a5de8f;
        }
        */
    </style>
</head>
<body>
<div>
    <input id="slider" type="range" value="1" min="1" max="100" step="1" width="200" />
    <span id="year">1950</span>
</div>
<script>

const diameter = Math.ceil(screen.width*0.6);
    format = d3.format(",d");

const svg = d3.select("body").append("svg")
    .attr("width", 2*diameter)
    .attr("height", diameter+200)
    .attr("id", "svg");

const g = svg.append("g").attr("transform", "translate(2,2)");

const pack = d3.pack()
    .size([diameter - 4, diameter - 4])
    .padding(1.5);

d3.json("./final_1.json",function(error, root) {
    var year = 1950;
    var choice = 0;
    d3.select("#slider").on("input", function() {
        var root_2 = root
        year = Number(1949) + Number(this.value)
        choice = this.value - 1
        d3.select('#year').text(year);
        //console.log(root_2);
        g.selectAll(".node").remove()
        draw_nodes(root_2,choice,year)
    });
    draw_nodes(root,0,1950)

})

    function draw_nodes(data,choice,year){
        var root_1 = d3.hierarchy(data)
            // ici on calcule l'emission par continent
            .sum(function(d) { if(d.data && d.data.annees[choice] == year) {return d.data.emissions[choice]} else return 0; })
            .sort(function(a, b) { return (  b.value - a.value); });
        // ici on recupÃ¨re la liste des noeuds (soit pays ou continent
        var node = g.selectAll(".node")
            .data(pack(root_1).descendants())
            .enter().append("g")
            .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        node.append("circle")
            .attr("r", function(d) { return d.r; })
            .attr("fill",function (d) {
                if(d.children){
                    return "#1F77B4";
                }else{
                    //console.log(d);
                    if((d.value/d.parent.value)>=0.3){
                        return "#b43122";
                    }else{
                        return "#1F77B4";
                    }
                }
            });
        node
            .on("mouseover",function (d) {
                if(d.children) {
                    //cici le cas de survoler le noeud monde
                    if(d.data.name === "monde") {
                        draw_graph(d.children, d.data.name, 1,"monde")
                    }else{
                        // ici le cas de survoler un continent
                        draw_graph(d.children, d.data.name, 2,d.data.name)
                    }
                    // ici le cas de survoler un pays
                }else{
                   // console.log(d)
                    draw_graph(d.data.data, d.data.pays, 3,d.parent.data.name)
                }
            }).on("mouseout",function () {
                svg.selectAll("path").remove()
                svg.select("#Xaxis").remove();
                svg.select("#Yaxis").remove();
                svg.select("#title").remove();
                svg.select("#surface").remove();
            //svg.selectAll("g").remove()
        })
        // ici pour chaque noeud on rajoute un titre qui s'affiche quand on survole un noeud(pays ou continent)
        node.append("title")
            .text(function(d) {var res; if(d.data.name ){res = d.data.name}else{res = d.data.pays} return res+ "\n" + "co2 emission for " +year+" is " + format(d.value); });
        node.filter(function(d) { return !d.children; })
            .append("text")
            .attr("dy", "0.3em")
            .style("font-weight", "bold")
            .attr("fill","#FFFFFF")
            .text(function(d) { return ( d.data.pays.substring(0, d.r / 3)); })
    }

    // une fonction qui sert a dessiner le line chart
    function draw_graph(data,title,indice,continent){
        var data_object = new Array();
        var total_emission = 0;
        var longueur_graph = Math.ceil(screen.width*0.4);
        switch (indice) {
            case 1:
                var sum ;
                for(var compt=0;compt<100;compt++) {
                    sum = 0;
                    for (var i = 0; i < data.length; i++) {
                        //data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})
                        for(var j=0;j<data[i].children.length;j++){
                            if(data[i].children[j].data.data.emissions[compt]) {
                                sum +=data[i].children[j].data.data.emissions[compt]
                            }
                        }
                    }
                    total_emission+= sum;
                    data_object.push({"annee":1950+compt,"emission":sum})
                }
                break;
            case 2:
                var sum;
                for(var compt=0;compt<100;compt++) {
                    sum = 0;
                    for (var i = 0; i < data.length; i++) {
                        //data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})

                            if(data[i].data.data.emissions[compt]) {
                                sum +=data[i].data.data.emissions[compt]
                            }

                    }
                    total_emission+= sum;
                    data_object.push({"annee":1950+compt,"emission":sum})
                }
                break;
            case 3:
                for(var i=0;i<data.annees.length;i++){
                    data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})
                }
                total_emission = d3.sum(data.emissions);
                break;
        }
       /* //console.log(data_object);
            for(var i=0;i<data.annees.length;i++){
                data_object.push({"annee":data.annees[i],"emission":data.emissions[i]})
            } */
        var y = d3.scaleLinear().range([longueur_graph, 100]);
        //var x = d3.scaleLinear().range([1100,1800])
        //var x = d3.scaleBand().range([1100,1800]);
        var parseTime = d3.timeParse("%d-%b-%y");
        var x = d3.scaleTime()
            .domain([new Date(1950,0,0),new Date(2050,1,1)])
            .range([diameter+20, diameter*1.7]);

        var xAxis = d3.axisBottom(x)
            .tickFormat(d3.timeFormat("%Y"));

        // define the line
        var valueline = d3.line()
            .x(function(d) { return x(new Date(d.annee,0,0)); })
            .y(function(d) { return y(d.emission); });
        // define the area
        //console.log(data)
        var area = d3.area()
            .x(function(d) { return x(new Date(d.annee,0,0)); })
            .y0(Math.ceil(screen.width*0.4))
            .y1(function(d) { return y(d.emission); });

       //x.domain(d3.extent(data_object, function(d) { return new Date(d.annee,0,0); }));
       y.domain([0, d3.max(data_object, function(d) { return d.emission; })]);
        //var tmp =d3.max(data.emissions, function(d) { return d; });
        //console.log(tmp);
        var z = ["#98abc5", "#a5de8f", "#7b6888", "#00FFFF", "#FFAF2B", "#d0743c", "#ff8c00","#b43122","#ffa268"];

        var continents = {"AFRIQUE":0,"EUROPE":1,"NORTH AMERICA":2,"ASIA":3,"AUSTRALIA":4,"SOUTH AMERICA":5,"OTHER":6,"CENTRAL AMERICA":7,"monde":8};
        //console.log(continents[continent]);
        //console.log(continent);
        //console.log(z(3));
        //console.log(x)

        var continent_number = continents[continent];
        //console.log(continent_number,z(continent_number))
        svg.append("path")
            .data([data_object])
            .attr("class", "area")
            .attr("d", area)
            .attr("fill", z[continent_number]);

        //console.log(z(continents[continent]));
        // add the valueline path.
        svg.append("path")
            .data([data_object])
            .attr("class", "line")
            .attr("d", valueline);

        svg.append("g")
            .attr("id","Xaxis")
            .attr("transform", "translate(0," + longueur_graph + ")")
            .call(xAxis);

        // add the Y Axis
        svg.append("g")
            .attr("id","Yaxis")
            .attr("transform", "translate(0" + (diameter+20)+ ")")
            .call(d3.axisLeft(y));
        // ici on ajoute le titre de line chart
        svg.append("text")
            .attr("x", diameter*1.4)
            .attr("y", 40)
            .attr("id","title")
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text(title+ " Co2 emissions line chart");

        svg.append("text")
            .attr("x", diameter*1.4)
            .attr("y", longueur_graph *0.8)
            .attr("id","surface")
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .style("font-weight", "bold")
            .text("Total emissions = "+ total_emission);
    }
</script>
</body>
</html>